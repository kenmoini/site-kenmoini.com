<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Every time I get on this site to try to write something and post a new blog entry, it just ends up in the Elephant Graveyard of Drafts.
I have half a dozen other posts waiting to be completed, on things such as how WordPress causes 1/3rd of the Internet to be vulnerable due to shipping old code, to a top-to-bottom view of Progressive Web Apps and Service Workers (super fun), OpenSCAP, and GPS NTP servers.'>
<meta name='theme-color' content='#de0066'>

<meta property='og:title' content='GitLab Container Registry with Minio Custom S3 Endpoint - Ken Moini'>
<meta property='og:description' content='Every time I get on this site to try to write something and post a new blog entry, it just ends up in the Elephant Graveyard of Drafts.
I have half a dozen other posts waiting to be completed, on things such as how WordPress causes 1/3rd of the Internet to be vulnerable due to shipping old code, to a top-to-bottom view of Progressive Web Apps and Service Workers (super fun), OpenSCAP, and GPS NTP servers.'>
<meta property='og:url' content='https://www.kenmoini.com/blog/gitlab-container-registry-with-minio-custom-s3-endpoint/'>
<meta property='og:site_name' content='Ken Moini'>
<meta property='og:type' content='article'><meta property='article:section' content='blog'><meta property='article:tag' content='amazon'><meta property='article:tag' content='ansible'><meta property='article:tag' content='aws'><meta property='article:tag' content='buildah'><meta property='article:tag' content='CI/CD'><meta property='article:tag' content='containers'><meta property='article:tag' content='devops'><meta property='article:tag' content='gitlab'><meta property='article:tag' content='minio'><meta property='article:tag' content='podman'><meta property='article:tag' content='red hat'><meta property='article:tag' content='rhel'><meta property='article:tag' content='s3'><meta property='article:tag' content='skopeo'><meta property='article:tag' content='storage'><meta property='article:published_time' content='2019-04-07T22:31:48-05:00'/><meta property='article:modified_time' content='2019-07-22T23:25:39-05:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@notkemo'>

<meta name="generator" content="Hugo 0.55.6" />

  <title>GitLab Container Registry with Minio Custom S3 Endpoint - Ken Moini</title>
  <link rel='canonical' href='https://www.kenmoini.com/blog/gitlab-container-registry-with-minio-custom-s3-endpoint/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.fb20af92.css'><link rel='stylesheet' href='/css/custom.css'><style>
    :root{--color-accent:#de0066;}
    blockquote { border-left: .2em solid#de0066;}
    :root{background-color:#000;}
    body{color:#EEE;}
    .title, h1, h2, h3, h4, h5, h6 {color:#EEE;}
    a, .menu a, .sidebar-toggler span, .sub-menu-toggler, .widget-social_menu a {color:#ff9800;}
    .menu li.current > a, a:focus, a:hover, .menu a:focus, .menu a:hover, .sidebar-toggler span:focus, .sidebar-toggler span:hover, .sub-menu-toggler:focus, .sub-menu-toggler:hover, .widget-social_menu a:focus, .widget-social_menu a:hover {color:#de0066;}
</style>
    
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap-grid.min.css">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/kemo.css">
<link href="/vendor/fontawesome-free-5.9.0-web/css/all.css" rel="stylesheet"> 
</head>
<body class='page type-blog'>

  <div class='site'><a class='screen-reader-text' href='#content'>Skip to Content</a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul>
      <li class="">
          <a href="/" title="Home - Ken Moini"><i class="fa fa-home"></i></a>
      </li><li class='item'>
        <a href='/about/' class="about">
          <span>About</span>
        </a>
      </li><li class='item'>
        <a href='/links/' class="links">
          <span>Links</span>
        </a>
      </li><li class='item'>
        <a href='/blog/' class="blog">
          <span>Blog</span>
        </a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>GitLab Container Registry with Minio Custom S3 Endpoint</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2019-04-07T22:31:48-05:00'>2019, Apr 07</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
4 mins read
</span>


  
  
</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<p>Every time I get on this site to try to write something and post a new blog entry, it just ends up in the Elephant Graveyard of Drafts.</p>

<p>I have half a dozen other posts waiting to be completed, on things such as how WordPress causes 1/3rd of the Internet to be vulnerable due to shipping old code, to a top-to-bottom view of Progressive Web Apps and Service Workers (super fun), OpenSCAP, and GPS NTP servers.  Just need time to sit down and finish them, which is easier said than done since many of those subjects are kind of in-depth.</p>

<p>I’ll keep this one short and simple: I’ve got a bunch of DevOps-y things running, two of them being Minio for S3 storage, and GitLab for SCM and to act as a Container Registry (!).  There were some issues in getting it to work together, here’s how I fixed them and to set GitLab’s Container Registry to use a custom S3 solution like Minio as a storage layer.</p>

<h2 id="k-i-s-s-me">K.I.S.S. Me</h2>

<p>Ok, so a complex problem – scalable enterprise application development with DIY S3 storage.  We’re building containers and managing them in a registry to enable some microservice based DevSecOps hoop-de-la and all sorts of other fun stuff.  Bottom line, I need to deploy a vendor-neutral S3 storage solution to back our container registry and applications.  Enter <a href="https://github.com/minio/minio">Minio</a>.</p>

<p><strong>Minio</strong> is an S3-compliant application stack which includes a server and client.  This means we can host our own &ldquo;AWS S3&rdquo; on any normal server anywhere.</p>

<p><strong>Now to make things even easier, I’ve created an Ansible Playbook that’ll configure any host you point it to configure and run a Minio server</strong>.  You can get all of the goodness here: <a href="https://github.com/kenmoini/ansible-minio">https://github.com/kenmoini/ansible-minio</a>.</p>

<p>Great, now that we’ve got a Minio server running just by running an Ansible Playbook, we can move onto our next task of installing GitLab.</p>

<p>Thankfully, installing GitLab couldn’t be easier.  <a href="https://about.gitlab.com/install/">Take a quick drive through the process</a>, or continue to the configuration steps.</p>

<h2 id="plug-n-play">Plug-n-Play</h2>

<p>So if you were to use Amazon’s S3 SaaS, it’s a quick and easy plug and play solution – drop a few variables in and it just knows where to go and what to do.</p>

<p>The documentation for GitLab is normally fantastic and very detailed, though it can’t cover every possible combination or configuration switch.  Though I do wish it were easier to find…I had to basically fuzz test with the Docker Distribution Registry options and find something that worked.  The documentation shows how to use an S3 store as the container registry storage backing, but not with a custom endpoint URL.</p>

<p>So let’s open up our /etc/gitlab/gitlab.rb file and modify a few things&hellip;</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#75715e"># vi /etc/gitlab/gitlab.rb</span></code></pre></div>

<p>You’ll want to find the section about registries and make sure your config looks at least a little like this:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">...
<span style="color:#75715e">################################################################################</span>
<span style="color:#75715e">## Container Registry settings</span>
<span style="color:#75715e">##! Docs: https://docs.gitlab.com/ce/administration/container_registry.html</span>
<span style="color:#75715e">################################################################################</span>

registry_external_url <span style="color:#e6db74">&#39;https://registry.gitlab.example.com&#39;</span>

<span style="color:#75715e">##c Settings used by GitLab application</span>
gitlab_rails[<span style="color:#e6db74">&#39;registry_enabled&#39;</span>] = <span style="color:#66d9ef">true</span>
gitlab_rails[<span style="color:#e6db74">&#39;registry_host&#39;</span>] = <span style="color:#e6db74">&#34;registry.gitlab.example.com&#34;</span>
gitlab_rails[<span style="color:#e6db74">&#39;registry_port&#39;</span>] = <span style="color:#e6db74">&#34;5000&#34;</span>
gitlab_rails[<span style="color:#e6db74">&#39;registry_path&#39;</span>] = <span style="color:#e6db74">&#34;/var/opt/gitlab/gitlab-rails/shared/registry&#34;</span>

<span style="color:#75715e">###! **Do not change the following 3 settings unless you know what you are</span>
<span style="color:#75715e">###!   doing**</span>
<span style="color:#75715e"># gitlab_rails[&#39;registry_api_url&#39;] = &#34;http://localhost:5000&#34;</span>
<span style="color:#75715e"># gitlab_rails[&#39;registry_key_path&#39;] = &#34;/var/opt/gitlab/gitlab-rails/certificate.key&#34;</span>
<span style="color:#75715e"># gitlab_rails[&#39;registry_issuer&#39;] = &#34;omnibus-gitlab-issuer&#34;</span>

<span style="color:#75715e">### Settings used by Registry application</span>
registry[<span style="color:#e6db74">&#39;enable&#39;</span>] = <span style="color:#66d9ef">true</span>
<span style="color:#75715e"># registry[&#39;username&#39;] = &#34;registry&#34;</span>
<span style="color:#75715e"># registry[&#39;group&#39;] = &#34;registry&#34;</span>
<span style="color:#75715e"># registry[&#39;uid&#39;] = nil</span>
<span style="color:#75715e"># registry[&#39;gid&#39;] = nil</span>
<span style="color:#75715e"># registry[&#39;dir&#39;] = &#34;/var/opt/gitlab/registry&#34;</span>
<span style="color:#75715e"># registry[&#39;registry_http_addr&#39;] = &#34;localhost:5000&#34;</span>
<span style="color:#75715e"># registry[&#39;debug_addr&#39;] = &#34;localhost:5001&#34;</span>
<span style="color:#75715e"># registry[&#39;log_directory&#39;] = &#34;/var/log/gitlab/registry&#34;</span>
<span style="color:#75715e"># registry[&#39;env_directory&#39;] = &#34;/opt/gitlab/etc/registry/env&#34;</span>
<span style="color:#75715e"># registry[&#39;env&#39;] = {</span>
<span style="color:#75715e">#   &#39;SSL_CERT_DIR&#39; =&gt; &#34;/opt/gitlab/embedded/ssl/certs/&#34;</span>
<span style="color:#75715e"># }</span>
<span style="color:#75715e"># registry[&#39;log_level&#39;] = &#34;info&#34;</span>
<span style="color:#75715e"># registry[&#39;log_formatter&#39;] = &#34;text&#34;</span>
<span style="color:#75715e"># registry[&#39;rootcertbundle&#39;] = &#34;/var/opt/gitlab/registry/certificate.crt&#34;</span>
<span style="color:#75715e"># registry[&#39;health_storagedriver_enabled&#39;] = true</span>
<span style="color:#75715e"># registry[&#39;storage_delete_enabled&#39;] = true</span>
<span style="color:#75715e"># registry[&#39;validation_enabled&#39;] = false</span>
<span style="color:#75715e"># registry[&#39;autoredirect&#39;] = false</span>
<span style="color:#75715e"># registry[&#39;compatibility_schema1_enabled&#39;] = false</span>

<span style="color:#75715e">### Registry backend storage</span>
<span style="color:#75715e">###! Docs: https://docs.gitlab.com/ce/administration/container_registry.html#container-registry-storage-driver</span>
registry[<span style="color:#e6db74">&#39;storage&#39;</span>] = {
  <span style="color:#e6db74">&#39;s3&#39;</span> =&gt; {
    <span style="color:#e6db74">&#39;accesskey&#39;</span> =&gt; <span style="color:#e6db74">&#39;myReallyLongAccessKey123&#39;</span>,
    <span style="color:#e6db74">&#39;secretkey&#39;</span> =&gt; <span style="color:#e6db74">&#39;mySuperSecretKey123&#39;</span>,
    <span style="color:#e6db74">&#39;bucket&#39;</span> =&gt; <span style="color:#e6db74">&#39;gitlab-registry&#39;</span>,
    <span style="color:#e6db74">&#39;region&#39;</span> =&gt; <span style="color:#e6db74">&#39;us-east-1&#39;</span>,
    <span style="color:#e6db74">&#39;regionendpoint&#39;</span> =&gt; <span style="color:#e6db74">&#39;http://minio.example.com:9000&#39;</span>,
    <span style="color:#e6db74">&#39;secure&#39;</span> =&gt; <span style="color:#66d9ef">false</span>,
    <span style="color:#e6db74">&#39;encrypt&#39;</span> =&gt; <span style="color:#66d9ef">false</span>,
    <span style="color:#e6db74">&#39;v4Auth&#39;</span> =&gt; <span style="color:#66d9ef">true</span>
  }
}
...</code></pre></div>

<p>Now once you change the GitLab configuration you need to run the Chef reconfiguration script…that’s easy too&hellip;</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># gitlab-ctl reconfigure</span></code></pre></div>

<h2 id="push-it-real-good">Push it real good</h2>

<p>Once you have GitLab reconfigured you can push to your Minio S3 GitLab-backed Container Registry! You’re using Podman, Buildah, and Skopeo, right?
<strong><em>Pro-tip:</em></strong> Don’t create OCI format containers if you’re planning on storing containers in GitLab. They use the Docker Distribution default registry which, well, only accepts Docker format containers, not OCI.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># podman login gitlab.example.com</span>
<span style="color:#75715e"># podman push base-rhel7 gitlab.example.com/my_user/my_repo/base-rhel7:latest</span></code></pre></div>

<figure class="col-sm-12 text-center">
    <img src="/images/content-stuff/k33jf.jpg"/> 
</figure>


</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='last-updated'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34" />
  <polygon points="18 2 22 6 12 16 8 16 8 12 18 2" />
  
</svg>
<span class='screen-reader-text'>Last updated: </span>
      <time class='entry-date' datetime='2019-07-22T23:25:39-05:00'>2019, Jul 22</time>
    </div><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/amazon/'>amazon</a>, <a class='tag' href='/tags/ansible/'>ansible</a>, <a class='tag' href='/tags/aws/'>aws</a>, <a class='tag' href='/tags/buildah/'>buildah</a>, <a class='tag' href='/tags/ci/cd/'>CI/CD</a>, <a class='tag' href='/tags/containers/'>containers</a>, <a class='tag' href='/tags/devops/'>devops</a>, <a class='tag' href='/tags/gitlab/'>gitlab</a>, <a class='tag' href='/tags/minio/'>minio</a>, <a class='tag' href='/tags/podman/'>podman</a>, <a class='tag' href='/tags/red-hat/'>red hat</a>, <a class='tag' href='/tags/rhel/'>rhel</a>, <a class='tag' href='/tags/s3/'>s3</a>, <a class='tag' href='/tags/skopeo/'>skopeo</a>, <a class='tag' href='/tags/storage/'>storage</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'>
  <div class="row"><div class='prev-entry sep-before col-sm-12 col-md-6'>
      <a href='/blog/a-third-of-the-internet-is-vulnerable/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>A Third of the Internet Is Vulnerable</a>
    </div><div class='next-entry sep-before col-sm-12 col-md-6 text-right'>
      <a href='/blog/kubernetes-on-linode-a-quick-start-of-sorts/'>
        <span class='screen-reader-text'>Next post: </span>Kubernetes on Linode – A Quick Start of Sorts<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
  </div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/kenmoini' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/notkemo' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='https://instagram.com/kenmoini' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Instagram account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
  <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
  <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:ken@kenmoini.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/kenmoini' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p></p>
</div>

          
          
          <small style="color:#333" class="muted"><em>Rev 58795f5</em></small>
          
        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src ="/assets/js/"</script>

<script src='https://www.kenmoini.com/assets/js/main.9e5c4cf4.js'></script><script src='/js/custom.js'></script>
</body>

</html>






















